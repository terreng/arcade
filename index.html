<html>
<head>

</head>
<body>
<style>
/* latin */
@font-face {
  font-family: 'Open Sans';
  font-style: normal;
  font-weight: 400;
  src: local('Open Sans Regular'), local('OpenSans-Regular'), url(font.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

body {
background-color: black;
font-family: 'Open Sans', sans-serif;
margin: 0;
--gold: gold;
overflow: hidden;
}

#title_top {
    width: 1920px;
    height: 245px;
    font-size: 110px;
    color: var(--gold);
    text-align: center;
    padding-top: 25px;
    position: absolute;
    z-index: 100;
    top: 0;
    background: linear-gradient(black, transparent);
}

#game_grid {
	height: calc(100% - 225px);
    margin-top: 200px;
}

#game_grid_inner {
	padding: 50px;
    overflow: hidden;
	transition: margin-top 0.18s ease 0s;
}

.game {
    margin: 25px;
    width: calc((100% / 3) - 100px);
    float: left;
    padding: 25px;
}

.game div:nth-child(1) {
    height: 382px;
}

.game img {
    height: 100%;
    width: 100%;
    object-fit: contain;
}

.game div:nth-child(2) {
    padding-top: 18px;
    font-size: 37px;
    color: white;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.game div:nth-child(3) {
    padding-top: 5px;
    font-size: 30px;
    color: #a7a7a7;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.game.selected {
    background: white;
    border-radius: 10px;
}

.game.selected div:nth-child(2) {
color: black;
}

.game.selected div:nth-child(3) {
color: #525252;
}

#main_menu {
    transition: 0.5s opacity;
	opacity: 1;
}

#game_fullscreen {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
	opacity: 0;
transition: 0.5s opacity;
}

#game_fullscreen iframe {
border: 0;
width: 100%;
height: 100%;
}

#exit_prompt {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
}

#exit_prompt_prompt {
    position: absolute;
    top: 50%;
    left: 50%;
    background: black;
    width: 700px;
    height: 336px;
    transform: translate(-50%,-50%);
    border-radius: 14px;
    box-shadow: 0 2px 20px 2px black;
}

#exit_prompt_prompt div:nth-child(1) {
    color: white;
    font-size: 45px;
    text-align: center;
    margin-top: 44px;
}

#exit_prompt_prompt div:nth-child(2) {
    font-size: 38px;
    padding: 26px;
    border: 2px solid white;
    color: white;
    border-radius: 16px;
    position: absolute;
    bottom: 40px;
    left: 40px;
}

#exit_prompt_prompt div:nth-child(3) {
    font-size: 38px;
    padding: 26px;
    border: 2px solid white;
    color: white;
    border-radius: 16px;
    position: absolute;
    bottom: 40px;
    right: 40px;
}

#exit_prompt_prompt div.selected {
    background-color: white;
    color: black;
}
</style>
<div id="main_menu">
<div id="title_top"><img src="logo.svg"></img></div>
<div id="game_grid">
<div id="game_grid_inner">
<div class="game">
<div>
<img src="thumbnail.png"></img>
</div>
<div>Title of the game</div>
<div>Author name</div>
</div>
</div>
</div>
</div>
<div id="game_fullscreen">

</div>
<div id="exit_prompt" style="display: none;">
<div id="exit_prompt_prompt">
<div>Do you really want to exit?</div>
<div id="prompt_cancel">Cancel</div>
<div id="prompt_confirm">Confirm</div>
</div>
</div>
<script>

function htmlescape(str) {
if (str == undefined) {
return str;
}
str = String(str);
return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
const ipc = require('electron').ipcRenderer;

var position = 0;

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

var games;

ipc.on('message', (event, message) => {
if (message.type == "main_load") {

var pendhtml = "";//REMEMBER TO GET NEW GOLD AND HTMLESCAPE

console.log(message.games)
games = message.games;

shuffle(message.games)

for (var i = 0; i < message.games.length; i++) {

pendhtml += '<div class="game" id="game_'+message.games[i].id+'"><div><img src="'+message.games[i].thumbnail+'"></img></div><div>'+htmlescape(message.games[i].title)+'</div><div>'+htmlescape(message.games[i].author)+'</div></div>'

}

console.log(pendhtml)

document.querySelectorAll("#game_grid_inner")[0].innerHTML = pendhtml;
reload_position();

}
if (message.type == "enter") {
if (on_menu) {
	document.querySelectorAll("#main_menu")[0].style.opacity = "0";
	document.querySelectorAll("#game_fullscreen")[0].innerHTML = '<iframe onload="gameFrameLoad()" src="'+games[position].path+'"></iframe>'
	setTimeout(function() {
		checkDisplayGame();
	},500)
	on_menu = false;
}
if (inexitprompt) {
	if (exit_selected == 0) {
		cancelExitPrompt();
	}
	if (exit_selected == 1) {
		confirmExitPrompt();
	}
}
}
if (message.type == "escape") {
if (in_game) {
if (inexitprompt) {
cancelExitPrompt();
} else {
exitPrompt();
}
}
}
if (message.type == "left") {
if (inexitprompt) {
	exit_selected = 0;
	document.querySelectorAll("#prompt_confirm")[0].classList.remove("selected");
	document.querySelectorAll("#prompt_cancel")[0].classList.add("selected");
}
if (on_menu) {
	if (position % 3 !== 0) {
		position -= 1;
		reload_position();
	}	
}
}
if (message.type == "right") {
if (inexitprompt) {
	exit_selected = 1;
	document.querySelectorAll("#prompt_confirm")[0].classList.add("selected");
	document.querySelectorAll("#prompt_cancel")[0].classList.remove("selected");
}
if (on_menu) {
	if (position % 3 !== 2 && !(position+1 == games.length)) {
		position += 1;
		reload_position();
	}
}
}
if (message.type == "up") {
if (on_menu) {
	if (!(position-2 <= 0)) {
		position -= 3;
		reload_position();
	}
}
}
if (message.type == "down") {
if (on_menu) {
	if (!(position+3 >= games.length)) {
		position += 3;
		reload_position();
	}
}
}
})

var keycode = 38;
var e = new KeyboardEvent( "keydown", { bubbles:true, cancelable:true, char:String.fromCharCode(keycode), key:String.fromCharCode(keycode), shiftKey:false, ctrlKey:false, altKey:false } );
Object.defineProperty(e, 'keyCode', {get : function() { return this.keyCodeVal; } });     
e.keyCodeVal = keycode;
document.querySelector("iframe").contentDocument.dispatchEvent(e);

function reload_position() {
var childs = document.querySelectorAll("#game_grid_inner")[0].children;
for (var i = 0; i < childs.length; i++) {
childs[i].classList.remove("selected");
}
childs[position].classList.add("selected");
document.querySelectorAll("#game_grid_inner")[0].style.marginTop = "-"+Math.floor(position/3)*581+"px";
}

var on_menu = true;
var in_game = false;

function exitGame() {
document.querySelectorAll("#game_fullscreen")[0].style.opacity = "0";
setTimeout(function() {
document.querySelectorAll("#main_menu")[0].style.opacity = "1";
document.querySelectorAll("#game_fullscreen")[0].innerHTML = "";
setTimeout(function() {
on_menu = true;
},500)
},500)
check = 0;
in_game = false;
}

function gameFrameLoad() {
var styles = '<style>#openfl-content {height: 100%; width: 100%;}canvas {height: 100% !important;width: 100%!important;object-fit: contain;margin-left: 0px !important;margin-top: 0px !important;}</style>';
document.querySelectorAll("iframe")[0].contentDocument.querySelector("body").insertAdjacentHTML("beforeend",styles);
checkDisplayGame();
}

var check = 0;
function checkDisplayGame() {
check++;
if (check == 2) {
document.querySelectorAll("#game_fullscreen")[0].style.opacity = "1";
document.querySelectorAll("iframe")[0].focus();
setTimeout(function() {
in_game = true;
},500)
}
}

const remote = require('electron').remote;
function exit() {
var window = remote.getCurrentWindow();
       window.close();
}

var exit_selected = 0;
var inexitprompt = false;

function exitPrompt() {
exit_selected = 0;
inexitprompt = true;
document.querySelectorAll("#exit_prompt")[0].style.display = "block";
document.querySelectorAll("#prompt_confirm")[0].classList.remove("selected");
document.querySelectorAll("#prompt_cancel")[0].classList.add("selected");
}

function cancelExitPrompt() {
inexitprompt = false;
document.querySelectorAll("#exit_prompt")[0].style.display = "none";
}

function confirmExitPrompt() {
inexitprompt = false;
document.querySelectorAll("#exit_prompt")[0].style.display = "none";
exitGame();
}
</script>
</body>
</html>